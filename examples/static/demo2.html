<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Attach Gateway Demo</title>
<script src="https://cdn.tailwindcss.com?plugins=forms@0.5.9"></script>
<style>
  body {font-family: system-ui, sans-serif;}
  body.log-open #inputBar {
    margin-bottom: 10rem; /* Adjust as needed to fit the log panel height */
  }
  #logPanel {
    transition: bottom 0.2s;
  }
</style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">
<header class="bg-white shadow sticky top-0 z-10">
  <div class="max-w-4xl mx-auto py-4 text-center text-xl font-semibold text-gray-700">Attach Gateway Demo</div>
</header>
<main class="flex-1 overflow-y-auto scroll-smooth max-w-4xl mx-auto w-full p-4 pb-32" id="transcript">
  <!-- messages appended here -->
</main>
<div class="fixed bottom-0 inset-x-0 bg-white border-t border-gray-200 z-20" id="inputBar">
  <div class="max-w-4xl mx-auto p-2 flex items-end gap-2">
    <div id="tabs" class="flex border rounded-md overflow-hidden text-sm">
      <button data-role="planner" class="px-3 py-1 bg-blue-100 text-blue-700" id="plannerTab">Ask Planner</button>
      <button data-role="coder" class="px-3 py-1 text-gray-600 hover:bg-gray-50" id="coderTab">Ask Coder</button>
    </div>
    <textarea id="chatInput" rows="1" class="flex-1 resize-none border rounded-md p-2 text-sm focus:outline-none" placeholder="Type a message..."></textarea>
    <button id="sendBtn" class="p-2 text-blue-700 hover:text-blue-800">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M2 21l21-9L2 3l5 9-5 9z"/></svg>
    </button>
  </div>
</div>
<div id="logPanel" class="fixed bottom-0 inset-x-0 bg-gray-900 text-gray-100 text-xs font-mono z-30">
  <div id="logHeader" class="flex items-center justify-between px-2 py-1 cursor-pointer border-t border-gray-700">
    <span>System Logs</span>
    <svg id="logChevron" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 transform transition-transform" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/></svg>
  </div>
  <div id="logs" class="hidden max-h-40 overflow-auto px-2 pb-1"></div>
</div>
<script>
const transcript = document.getElementById('transcript');
const logs = document.getElementById('logs');
const input = document.getElementById('chatInput');
const plannerTab = document.getElementById('plannerTab');
const coderTab = document.getElementById('coderTab');
const sendBtn = document.getElementById('sendBtn');
const logPanel = document.getElementById('logPanel');
const inputBar = document.getElementById('inputBar');
let activeRole = 'planner';

function switchTab(role){
  activeRole = role;
  plannerTab.classList.toggle('bg-blue-100', role === 'planner');
  plannerTab.classList.toggle('text-blue-700', role === 'planner');
  coderTab.classList.toggle('bg-blue-100', role === 'coder');
  coderTab.classList.toggle('text-blue-700', role === 'coder');
}

plannerTab.onclick = () => switchTab('planner');
coderTab.onclick = () => switchTab('coder');

function autoGrow(){
  const newHeight = Math.max(this.scrollHeight, 32);
  if (this.style.height !== `${newHeight}px`) {
    this.style.height = 'auto';
    this.style.height = `${newHeight}px`;
  }
}
input.addEventListener('input', autoGrow);

function appendMessage(role, text, fromUser=false){
  const wrap = document.createElement('div');
  wrap.className = fromUser ? 'flex justify-end mb-3' : 'flex mb-3';
  const bubble = document.createElement('div');
  bubble.className = 'relative rounded-lg p-3 shadow text-sm';
  if(fromUser){
    bubble.classList.add('bg-blue-500','text-white');
  } else {
    bubble.classList.add('bg-gray-100','text-gray-900');
    const chip = document.createElement('span');
    chip.className = 'absolute -left-2 sm:-left-3 top-1 w-6 h-6 rounded-full text-xs flex items-center justify-center';
    if(role === 'planner'){
      chip.textContent = 'ðŸ’¡';
      chip.classList.add('bg-blue-200');
    } else {
      chip.textContent = 'ðŸ”§';
      chip.classList.add('bg-green-200');
    }
    bubble.appendChild(chip);
  }
  const msg = document.createElement('div');
  msg.textContent = text;
  bubble.appendChild(msg);
  const icons = document.createElement('div');
  icons.className = 'flex gap-2 mt-1 justify-end text-gray-400';
  icons.innerHTML = `
    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 2H8a2 2 0 00-2 2v16a2 2 0 002 2h8a2 2 0 002-2V4a2 2 0 00-2-2z"/><path d="M9 4h6v2H9z"/></svg>
    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12h16M12 4l8 8-8 8"/></svg>
    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v18M8 7l4-4 4 4"/></svg>`;
  bubble.appendChild(icons);
  wrap.appendChild(bubble);
  transcript.appendChild(wrap);
  bubble.scrollIntoView();
}

function log(msg){
  const line = document.createElement('div');
  line.textContent = msg;
  logs.appendChild(line);
  logs.scrollTop = logs.scrollHeight;
}

function sendMessage(){
  const text = input.value.trim();
  if(!text) return;
  appendMessage(activeRole, text, true);
  log(`You -> ${activeRole}: ${text}`);
  input.value = '';
  autoGrow.call(input);
  sendBtn.disabled = true;
  // TODO: send message to backend or websocket
  setTimeout(() => {
    appendMessage(activeRole, text);
    log(`${activeRole} responded`);
    sendBtn.disabled = false;
  }, 300);
}

sendBtn.onclick = sendMessage;
input.addEventListener('keydown', e => {
  if(e.key === 'Enter' && (e.metaKey || e.ctrlKey)){
    e.preventDefault();
    sendMessage();
  }
});

document.getElementById('logHeader').onclick = () => {
  logs.classList.toggle('hidden');
  document.getElementById('logChevron').classList.toggle('rotate-180');
  if (logs.classList.contains('hidden')) {
    document.body.classList.remove('log-open');
  } else {
    document.body.classList.add('log-open');
  }
};
</script>
</body>
</html>
